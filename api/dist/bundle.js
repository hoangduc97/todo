!function(e){var t={};function s(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,a){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(s.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(a,n,function(t){return e[t]}.bind(null,n));return a},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=9)}([function(e,t){e.exports=require("express-validator")},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("bcryptjs")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("passport")},function(e,t){e.exports=require("passport-jwt")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("morgan")},function(e,t,s){"use strict";s.r(t);var a=s(2),n=s.n(a),r=s(7),o=s.n(r),i=s(1),c=s.n(i);const d={useNewUrlParser:!0,useUnifiedTopology:!0,useCreateIndex:!0};var u={connect_mongo:()=>c.a.connect("mongodb+srv://Zrik:Bongtoi1@todos.ghc5a.mongodb.net/todos?retryWrites=true&w=majority",d)},l=s(0),p=s(4),y=s.n(p);const f=e=>{if(e&&e.authorization){const t=e.authorization.split(" ");if(t&&2===t.length)return y.a.verify(t[1],"XXXXXXXXXXXX")}return null},h=e=>{if(e){return"JWT "+y.a.sign({id:e._id,email:e.email},"XXXXXXXXXXXX",{expiresIn:"30m"})}},w=201,m=400,g=200,_=400,X=400,b=200,v=400;class j extends Error{constructor(e,t,s){super(),this.statusCode=e,this.message=t,this.errorCode=s}}var O=s(3),T=s.n(O);const S=new c.a.Schema({email:{type:String,unique:!0,trim:!0},password:{type:String,required:!0}});S.pre("save",(function(e){let t=this;this.isModified("password")||this.isNew?T.a.genSalt(10,(function(s,a){if(s)return e(s);T.a.hash(t.password,a,(function(s,a){if(s)return e(s);t.password=a,e()}))})):e()})),S.methods.comparePassword=function(e,t){T.a.compare(e,this.password,(function(e,s){if(e)return t(e);t(null,s)}))};var E=c.a.model("User",S);var A={register:async(e,t,s)=>{try{if(!Object(l.validationResult)(e).isEmpty())throw new j(m,"Invalid Register Type",13021);const{email:s,password:a}=e.body;if(await E.findOne({email:s}))throw new j(m,"User already exists",1309);new E({email:s,password:a}).save({},async(e,s)=>{if(e)throw new j(m,"Account create failed",1310);console.log(s);const a=await h(s);return t.status(w).json({success:!0,message:"Account create success",token:a})})}catch(e){s(e)}},login:async(e,t,s)=>{try{if(!Object(l.validationResult)(e).isEmpty())throw new j(_,"Invalid Login Type",1302);const{email:s,password:a}=e.body,n=await E.findOne({email:s});if(!n)throw new j(_,"Login Error",1304);n.comparePassword(a,(e,s)=>{if(s&&!e){const e=h(n);return t.status(g).json({success:!0,token:e,message:"Login success"})}throw new j(_,"Login Error",1304)})}catch(e){s(e)}},getAll:async(e,t,s)=>{try{E.find({}).then(e=>t.status(g).json({success:!0,message:"Data found",data:e})).catch(e=>{throw new j(_,"Not found",1105)})}catch(e){s(e)}}};const x=[Object(l.check)("email","Please enter a valid email").isEmail(),Object(l.check)("password","Please enter a valid password").isLength({min:6})],P=[Object(l.check)("email","Please enter a valid email").isEmail(),Object(l.check)("password","Please enter a valid password").isLength({min:6})],R=n.a.Router();R.post("/register",[...x],A.register),R.post("/login",[...P],A.login);var k=R,I=s(5),D=s.n(I),U=s(6),q=s.n(U);const C={jwtFromRequest:q.a.ExtractJwt.fromAuthHeaderWithScheme("jwt"),secretOrKey:"XXXXXXXXXXXX"};D.a.use(new q.a.Strategy(C,(e,t)=>{E.findOne({_id:e.id},(e,s)=>{e&&t(e,!1),t(null,s||!1)})}));var H=D.a;const L=()=>(e,t,s)=>{H.authenticate("jwt",{session:!1},e=>{if(e)return t.status(403).json({message:"forbidden"});s()})(e,t,s)},N=new c.a.Schema({title:{type:String,required:!0},completed:{type:Boolean,default:!1},note:{type:String},priority:{type:Number,enum:[0,1,2,3]},due_date:{type:Date},list:{type:c.a.Types.ObjectId,ref:"List"}});var W=c.a.model("Task",N);const J=new c.a.Schema({user_id:{type:c.a.Types.ObjectId,required:!0},title:{type:String,required:!0},tasks:[{type:c.a.Types.ObjectId,ref:"Task"}]});var B=c.a.model("List",J);var M={_get:async(e,t,s)=>{try{const s={list:e.params.list_id};W.find(s).then(e=>t.status(g).json({success:!0,message:"Data Found",data:e})).catch(e=>{throw new j(_,"Data not found",1105)})}catch(e){s(e)}},_create:async(e,t,s)=>{try{const s=Object(l.validationResult)(e);if(!s.isEmpty())throw new j(m,s.toString(),1302);const a=e.params.list_id,n={title:e.body.title,completed:e.body.completed,note:e.body.note,priority:e.body.priority,due_date:e.body.due_date,list:a};if(!await B.findById({_id:n.list}))throw new j(m,"List not existed",1105);new W(n).save().then(async e=>(await B.findByIdAndUpdate({_id:e.list},{$push:{tasks:e._id}}),t.status(w).json({success:!0,message:"Created successful",data:e}))).catch(e=>{throw new j(m,"Create failure",1105)})}catch(e){s(e)}},_update:async(e,t,s)=>{try{const s=Object(l.validationResult)(e);if(!s.isEmpty())throw new j(X,s.toString(),1302);const a={_id:e.params.id},n={title:e.body.title,completed:e.body.completed,note:e.body.note,priority:e.body.priority,due_date:e.body.due_date};await W.findOneAndUpdate(a,n,{new:!0}).exec().then(e=>t.status(w).json({success:!0,message:"Updated successful",data:e})).catch(e=>{throw new j(m,"Update failure",1105)})}catch(e){s(e)}},_delete:async(e,t,s)=>{try{const s={_id:e.params.id};await W.findOneAndDelete(s).then(async e=>t.status(b).json({success:!0,message:"Deleted successful",data:e})).catch(e=>{throw new j(v,"Deleted failure",1105)})}catch(e){s(e)}}};var K=[Object(l.check)("title").notEmpty(),Object(l.check)("completed").notEmpty()];const F=n.a.Router();F.get("/:list_id",[L()],M._get),F.post("/:list_id",[L(),...K],M._create),F.put("/:id",[L(),...K],M._update),F.delete("/:id",[L()],M._delete);var z=F;var G={_getAll:async(e,t,s)=>{try{const s={user_id:(await f(e.headers)).id};B.find(s).populate("tasks").then(e=>t.status(g).json({success:!0,message:"Data Found",data:e})).catch(e=>{throw new j(_,"Data not found",1105)})}catch(e){s(e)}},_getOne:async(e,t,s)=>{try{const s={_id:e.params.id};B.find(s).populate("tasks").then(e=>t.status(g).json({success:!0,message:"Data Found",data:e})).catch(e=>{throw new j(_,"Data not found",1105)})}catch(e){s(e)}},_create:async(e,t,s)=>{try{const s=Object(l.validationResult)(e);if(!s.isEmpty())throw new j(m,s.toString(),1302);const a={user_id:(await f(e.headers)).id,title:e.body.title,tasks:[]};new B(a).save().then(e=>t.status(w).json({success:!0,message:"Created successful",data:e})).catch(e=>{throw new j(m,"Create failure",1105)})}catch(e){s(e)}},_update:async(e,t,s)=>{try{const s=Object(l.validationResult)(e);if(!s.isEmpty())throw new j(X,s.toString(),1302);const a={_id:e.params.id},n={title:e.body.title};await B.findOneAndUpdate(a,n,{new:!0}).exec().then(e=>t.status(w).json({success:!0,message:"Updated successful",data:e})).catch(e=>{throw new j(m,"Update failure",1105)})}catch(e){s(e)}},_delete:async(e,t,s)=>{try{const s={_id:e.params.id};await B.findOneAndDelete(s,update_task).then(async e=>(await W.deleteMany({list:s._id}),t.status(b).json({success:!0,message:"Deleted successful",data:e}))).catch(e=>{throw new j(v,"Deleted failure",1105)})}catch(e){s(e)}}};var Z=[Object(l.check)("title").notEmpty()];const V=n.a.Router();V.get("/",[L()],G._getAll),V.get("/:id",[L()],G._getOne),V.post("/",[L(),...Z],G._create),V.put("/:id",[L(),...Z],G._update),V.delete("/:id",[L()],G._delete);var Y=V;const $=n.a.Router();$.use("/user",k),$.use("/list",Y),$.use("/task",z);var Q=$;var ee={origin:"http://localhost",optionSuccessStatus:200,allowedHeaders:["Content-Type","Authorization"]},te=s(8),se=s.n(te);const ae=n()(),ne={API_PORT:"3000",CLIENT_PORT:"80",DB_URI:"mongodb+srv://Zrik:Bongtoi1@todos.ghc5a.mongodb.net/todos?retryWrites=true&w=majority",JWT_SCHEME:"jwt",JWT_TOKEN_PREFIX:"JWT",JWT_SECRET_OR_KEY:"XXXXXXXXXXXX",JWT_TOKEN_EXPIRATION:"30m",JWT_TOKEN_HASH_ALGO:"XXXX",BASE_PATH:"/api/v1",USER_PATH:"/user",TASK_PATH:"/task",LIST_PATH:"/list",AUTH_REGISTER_PATH:"/register",AUTH_LOGIN_PATH:"/login",PASSWORD_DURATION:"90"}.API_ENV||"prod";ae.use(se()(ne)),ae.use(n.a.json()),ae.use(n.a.urlencoded({extended:!1})),ae.use(o()(ee)),ae.use(H.initialize()),ae.use("/api/v1",Q),u.connect_mongo().then(()=>{console.log("connect database success!")}).catch(e=>{console.error(e)}),ae.use((e,t,s,a)=>(console.log(e),e.errorCode?((e,t)=>{const{statusCode:s,message:a,errorCode:n}=e;return t.status(s).json({success:!1,message:a,error_code:n})})(e,s):s.status(500).json({success:!1,message:"App Server Error, please contact the admin",error_code:1e3})));ae.listen("3000",()=>{console.log("server running with port 3000")})}]);